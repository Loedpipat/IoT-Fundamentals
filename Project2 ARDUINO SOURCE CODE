#include <Wire.h>
#include <WiFi.h>
#include <HTTPClient.h>
#include <PubSubClient.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_HTS221.h>
#include <Adafruit_BMP280.h>
#include <Adafruit_SHT4x.h>
#include <Adafruit_MPU6050.h>
#include <time.h>
#include <NTPClient.h>
#include <freertos/queue.h>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>
#include <stdlib.h>

// Wi-Fi credentials
#define WIFI_SSID "CUHomeWiFi(2.4G)-1601"
#define WIFI_PASSWORD "420463772"

// MQTT Credentials for NETPIE
const char* mqtt_server = "broker.netpie.io";
const int mqtt_port = 1883;
const char* mqtt_clientID = "3628f6e5-eddd-4907-bf3d-07f49819d24c";
const char* mqtt_username = "eqLncTz2CpDfxtR3fGohKhZHxkpzCS36";
const char* mqtt_password = "bLAvV7mtjDunGVaMxzXANqkXpCM4khPs";

// Sensor objects
Adafruit_HTS221 hts;
Adafruit_SHT4x sht4;
Adafruit_BMP280 bmp;
Adafruit_MPU6050 mpu;

// Wi-Fi and MQTT client
WiFiClient espClient;
PubSubClient client(espClient);

// Queue for sensor data
struct SensorData {
    float temperature;
    float humidity;
    float pressure;
    float accelX, accelY, accelZ;
    float gyroX, gyroY, gyroZ;
};
QueueHandle_t sensorDataQueue;

// ‚úÖ Function: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ WiFi
void connectToWiFi() {
    WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
    int retry = 0;
    while (WiFi.status() != WL_CONNECTED && retry < 10) {
        delay(2000);
        Serial.print(".");
        retry++;
    }
    if (WiFi.status() == WL_CONNECTED) {
        Serial.println("\n‚úÖ Connected to WiFi.");
    } else {
        Serial.println("\n‚ùå WiFi Connection Failed! Restarting ESP32...");
        ESP.restart();
    }
}

// ‚úÖ Function: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ NETPIE MQTT
void connectToNETPIE() {
    client.setServer(mqtt_server, mqtt_port);
    int retry = 0;
    while (!client.connected() && retry < 5) {
        Serial.print("Attempting MQTT connection...");
        if (client.connect(mqtt_clientID, mqtt_username, mqtt_password)) {
            Serial.println("‚úÖ Connected to NETPIE MQTT.");
        } else {
            Serial.print("‚ùå Failed, rc=");
            Serial.print(client.state());
            Serial.println(" Retrying in 5 seconds...");
            retry++;
            delay(5000);
        }
    }
    if (!client.connected()) {
        Serial.println("üö® MQTT Connection Failed! Restarting ESP32...");
        ESP.restart();
    }
}

// ‚úÖ Task: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Queue ‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
void getData(void *pvParameters) {
    SensorData data;
    for (;;) {
        sensors_event_t HTS221_humidity, HTS221_temp, bmp_temp, bmp_pressure;
        sensors_event_t accel, gyro;
        bool sensorFound = false;

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å HTS221 ‡∏´‡∏£‡∏∑‡∏≠ SHT4x
        if (hts.begin_I2C()) {
            hts.getEvent(&HTS221_humidity, &HTS221_temp);
            data.temperature = HTS221_temp.temperature;
            data.humidity = HTS221_humidity.relative_humidity;
            sensorFound = true;
        } else if (sht4.begin()) {
            sensors_event_t sht_humid, sht_temp;
            sht4.getEvent(&sht_humid, &sht_temp);
            data.temperature = sht_temp.temperature;
            data.humidity = sht_humid.relative_humidity;
            sensorFound = true;
        }

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏à‡∏≤‡∏Å BMP280
        if (bmp.begin(0x76)) {
            bmp.getTemperatureSensor()->getEvent(&bmp_temp);
            bmp.getPressureSensor()->getEvent(&bmp_pressure);
            data.pressure = bmp_pressure.pressure;
            sensorFound = true;
        }

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ Acceleration ‡πÅ‡∏•‡∏∞ Gyroscope ‡∏à‡∏≤‡∏Å MPU6050
        if (mpu.begin()) {
            mpu.getEvent(&accel, &gyro, &bmp_temp);
            data.accelX = accel.acceleration.x;
            data.accelY = accel.acceleration.y;
            data.accelZ = accel.acceleration.z;
            data.gyroX = gyro.gyro.x;
            data.gyroY = gyro.gyro.y;
            data.gyroZ = gyro.gyro.z;
            sensorFound = true;
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Queue
        if (sensorFound) {
            xQueueSend(sensorDataQueue, &data, (TickType_t)10);
            Serial.println("üì¶ Sensor Data Queued");
        }

        vTaskDelay(pdMS_TO_TICKS(10000));  // ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    }
}

// ‚úÖ Task: ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á NETPIE MQTT ‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
void PublishData(void *pvParameters) {
    SensorData data;
    for (;;) {
        if (xQueueReceive(sensorDataQueue, &data, portMAX_DELAY)) {
            if (!client.connected()) {
                connectToNETPIE();
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á JSON ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Shadow
            String jsonData = "{\"data\": {"
                              "\"temperature\": " + String(data.temperature, 2) + 
                              ", \"humidity\": " + String(data.humidity, 2) + 
                              ", \"pressure\": " + String(data.pressure, 2) + 
                              ", \"accelX\": " + String(data.accelX, 2) + 
                              ", \"accelY\": " + String(data.accelY, 2) + "}}";

            // ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á NETPIE
            if (client.publish("@shadow/data/update", jsonData.c_str(), true)) {
                Serial.println("‚úÖ Data sent to NETPIE Shadow: " + jsonData);
            } else {
                Serial.println("‚ùå Failed to send data to NETPIE Shadow!");
            }

            vTaskDelay(pdMS_TO_TICKS(10000));  // ‡∏™‡πà‡∏á‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        }
    }
}

void setup() {
    Serial.begin(115200);
    Wire.begin(41, 40);

    connectToWiFi();
    connectToNETPIE();

    Serial.println("üîç Checking sensors...");

    if (mpu.begin()) {
        Serial.println("‚úÖ MPU6050 detected.");
    } else {
        Serial.println("‚ùå MPU6050 not found.");
    }

    while (!bmp.begin(0x76)) {
        Serial.println("‚ö†Ô∏è BMP280 not detected. Retrying...");
        delay(2000);
    }
    Serial.println("‚úÖ Found BMP280 sensor.");

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Queue ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Sensor Data
    sensorDataQueue = xQueueCreate(10, sizeof(SensorData));

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Thread ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤
    xTaskCreate(getData, "SensorTask", 10000, NULL, 1, NULL);
    xTaskCreate(PublishData, "MqttTask", 10000, NULL, 1, NULL);
}

void loop() {
    client.loop();
}
